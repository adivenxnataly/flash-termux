#!/data/data/com.termux/files/usr/bin/bash

r3="\033[31m"
g3="\033[32m"
y1="\033[33m"
b1="\033[34m"
r5="\033[0m"

slot=""
force=false
while [[ $# -gt 0 ]]; do
    case $1 in
        --slot)
            slot="$2"
            shift 2
            ;;
        --force)
            force=true
            shift
            ;;
        *)
            mode="$1"
            shift
            ;;
    esac
done

LOG_FILE="flash.log"
IMGS_DIR="$(pwd)"

log() {
    echo -e "${y1}$(date '+%Y-%m-%d %H:%M:%S')${r5} - $1" | tee -a "$LOG_FILE"
}

confirm() {
    if $force; then return 0; fi
    echo -ne "${y1}>> $1 (y/n)? ${r5}"
    read -r choice
    case "$choice" in
        y|Y) return 0 ;;
        *) log "${r3}Operation cancelled${r5}"; return 1 ;;
    esac
}

check_images() {
    local img_count=$(ls *.img *.bin 2>/dev/null | wc -l)
    if [ "$img_count" -eq 0 ]; then
        log "${r3}ERROR: No .img or .bin files found in current directory!${r5}"
        log "Please cd to the directory containing your firmware images"
        exit 1
    fi
}

set_slot() {
    if [ -n "$slot" ]; then
        log "${g3}Setting active slot to ${slot}...${r5}"
        fastboot set_active "$slot" || {
            log "${r3}Failed to set active slot!${r5}"
            exit 1
        }
        fastboot oem cdms
    fi
}

flash_partition() {
    local partition="$1"
    local img="$2"
    
    if [ -n "$slot" ] && [[ "$partition" != "super" ]]; then
        partition="${partition}_${slot}"
    fi
    
    log "${b1}Flashing $partition...${r5}"
    fastboot flash "$partition" "$img" || {
        log "${r3}Failed to flash $partition!${r5}"
        return 1
    }
}

erase_partitions() {
    log "${r3}Starting data wipe...${r5}"
    partitions=("userdata" "metadata" "cache" "cust" "md_udc" "frp")
    
    for partition in "${partitions[@]}"; do
        if confirm " Erase ${partition} partition?"; then
            log "${b1}Erasing ${partition}...${r5}"
            fastboot erase "$partition" || {
                log "${r3}Failed to erase ${partition}!${r5}"
            }
        fi
    done
}

log "Starting flash process:"

fastboot devices | grep -q "fastboot" || {
    log "${r3}No device in fastboot mode!${r5}"
    exit 1
}

check_images
set_slot

if [ "$mode" == "all" ]; then
    if confirm " ${r3}WARNING: This will ERASE ALL USER DATA! Continue?${r5}"; then
        erase_partitions
    else
        log "${r3}Data wipe cancelled!${r5}"
    fi
elif [ "$mode" == "keep_data" ]; then
    log "${g3}Keeping user data (no wipe will be performed)${r5}"
else
    log "${r3}Unknown command!${r5}"
    exit 1
fi

for vbmeta in vbmeta*.img; do
    [ -f "$vbmeta" ] || continue
    partition=$(basename "$vbmeta" .img)
    flash_partition "$partition" "$vbmeta"
done

preloader=(preloader*)
if [ ${#preloaders[@]} -eq 1 ]; then
    confirm " Flash preloader (dangerous operation)" && \
    flash_partition "preloader" "${preloaders[0]}"
fi

for img in *.img *.bin; do
    [ -f "$img" ] || continue
    
    case "$img" in
        vbmeta*|preloader*) continue ;;
        *)
            partition=$(basename "$img" .img)
            partition=$(basename "$partition" .bin)
            
            flash_partition "$partition" "$img"
            ;;
    esac
done

log "${g3}SUCCESS: Flashing completed!${r5}"
log "Rebooting to recovery..."
fastboot reboot recovery
